# Структура проекта

## Обзор

Проект состоит из двух основных ROS пакетов:

1. **sim_pkg** - Gazebo симуляция с роботом и внешней камерой
2. **tracker_pkg** - Python модуль для трекинга робота по цветным меткам

## Структура директорий

```
ysl/
├── README.md                    # Основное описание проекта
├── INSTALL.md                   # Подробная инструкция по установке
├── QUICKSTART.md                # Быстрый старт
├── PROJECT_STRUCTURE.md         # Этот файл
├── setup.sh                     # Скрипт установки зависимостей
├── .gitignore                   # Git ignore правила
│
├── gazebo/
│   └── sim_pkg/                 # Пакет симуляции Gazebo
│       ├── package.xml           # Описание пакета
│       ├── CMakeLists.txt        # CMake конфигурация
│       ├── README.md             # Документация пакета
│       ├── launch/
│       │   ├── sim.launch        # Запуск симуляции
│       │   └── demo.launch       # Полный запуск (симуляция + трекер + rviz)
│       ├── worlds/
│       │   └── arena.world       # Мир Gazebo с камерой
│       └── models/
│           └── robot_with_markers/
│               └── model.sdf    # Модель робота с цветными метками
│
└── python/
    └── tracker_pkg/              # Пакет трекера
        ├── package.xml           # Описание пакета
        ├── CMakeLists.txt        # CMake конфигурация
        ├── README.md             # Документация пакета
        ├── launch/
        │   └── tracker.launch    # Запуск трекера
        ├── config/
        │   └── tracker.yaml      # Параметры конфигурации
        ├── scripts/
        │   ├── tracker_node.py   # Основная нода трекера
        │   ├── offline_visualizer.py  # Оффлайн визуализатор траектории
        │   └── camera_debug.py   # Утилита для отладки камеры
        └── rviz/
            └── tracker.rviz      # Конфигурация RViz
```

## Основные компоненты

### sim_pkg (Gazebo симуляция)

**Назначение:** Обеспечивает симуляцию робота с цветными метками и внешней камерой.

**Ключевые файлы:**

- `launch/sim.launch` - запускает Gazebo с миром arena.world и спавнит робота
- `launch/demo.launch` - запускает полную систему (симуляция + трекер + rviz)
- `worlds/arena.world` - описание мира с внешней камерой
- `models/robot_with_markers/model.sdf` - модель робота с красной и синей метками

**Публикуемые топики:**

- `/camera/image_raw` - изображение с камеры
- `/camera/camera_info` - параметры камеры (intrinsics)
- `/tf_static` - статический transform world -> camera_link

### tracker_pkg (Трекер)

**Назначение:** Обрабатывает изображения с камеры, детектирует цветные метки и вычисляет позу робота.

**Ключевые файлы:**

- `scripts/tracker_node.py` - основная нода:
  - Подписывается на `/camera/image_raw` и `/camera/camera_info`
  - Детектирует красную и синюю метки используя OpenCV
  - Вычисляет мировые координаты через camera intrinsics + TF + ray-plane intersection
  - Публикует позу робота и траекторию
- `scripts/offline_visualizer.py` - визуализатор сохраненных траекторий:
  - Читает CSV/JSON файлы с траекторией
  - Рисует 2D траекторию с интерактивным ползунком времени
  - Позволяет кликать на точки для просмотра координат
- `config/tracker.yaml` - параметры конфигурации:
  - HSV пороги для меток
  - Параметры фильтрации контуров
  - Настройки логирования

**Публикуемые топики:**

- `/robot_pose_external` - текущая поза робота (geometry_msgs/PoseStamped)
- `/robot_path_external` - траектория движения (nav_msgs/Path)
- `/debug/image` - изображение с отрисованными метками

**Сохраняемые данные:**

- Траектория в CSV/JSON формате (по умолчанию `~/tracker_logs/trajectory.csv`)

## Алгоритм работы

1. **Gazebo** симулирует робота с цветными метками и публикует изображения с внешней камеры
2. **tracker_node** получает изображения и:
   - Конвертирует в HSV цветовое пространство
   - Применяет пороговую фильтрацию для красной и синей меток
   - Находит центроиды меток
   - Использует camera intrinsics для unproject пикселей в лучи
   - Преобразует лучи в мировую систему через TF transform
   - Пересекает лучи с плоскостью пола (z=0) для получения 3D координат
   - Вычисляет центр робота (середина между метками) и ориентацию (atan2)
3. **Публикация результатов:**
   - Поза робота публикуется в `/robot_pose_external`
   - Траектория накапливается и публикуется в `/robot_path_external`
   - Debug изображение с метками публикуется в `/debug/image`
4. **Визуализация:**
   - RViz показывает траекторию и текущую позу
   - Оффлайн визуализатор позволяет анализировать сохраненную траекторию

## Зависимости

### ROS пакеты:

- `cv_bridge` - конвертация между ROS Image и OpenCV
- `tf2_ros` - работа с трансформациями
- `gazebo_ros` - интеграция Gazebo с ROS
- `gazebo_plugins` - плагины для Gazebo

### Python библиотеки:

- `opencv-python` - обработка изображений
- `numpy` - численные вычисления
- `matplotlib` - визуализация

## Запуск

См. [QUICKSTART.md](QUICKSTART.md) для быстрого старта или [INSTALL.md](INSTALL.md) для подробной инструкции.
